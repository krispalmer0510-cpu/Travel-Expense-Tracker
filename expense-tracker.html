<script>
class ExpenseTracker {
    constructor() {
        this.expenses = this.loadExpenses();
        this.initializeForm();
        this.updateDisplay();
        this.setDefaultDate();
    }

    loadExpenses() {
        const stored = localStorage.getItem('quickExpenses');
        return stored ? JSON.parse(stored) : [];
    }

    saveExpenses() {
        localStorage.setItem('quickExpenses', JSON.stringify(this.expenses));
    }

    setDefaultDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
    }

    initializeForm() {
        const form = document.getElementById('expenseForm');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const copyBtn = document.getElementById('copyBtn');

        form.addEventListener('submit', (e) => this.handleSubmit(e));
        exportBtn.addEventListener('click', () => this.showExport());
        clearBtn.addEventListener('click', () => this.clearAll());
        copyBtn.addEventListener('click', () => this.copyToClipboard());
    }

    handleSubmit(e) {
        e.preventDefault();

        const expense = {
            id: Date.now(),
            date: document.getElementById('date').value,
            currency: document.getElementById('currency').value,
            amount: parseFloat(document.getElementById('amount').value),
            description: document.getElementById('description').value.trim(),
            timestamp: new Date().toISOString()
        };

        this.expenses.unshift(expense);
        this.saveExpenses();
        this.updateDisplay();
        this.resetForm();
        this.showSuccess();

        // Generate CSV after adding expense
        this.downloadCSV();
    }

    resetForm() {
        document.getElementById('amount').value = '';
        document.getElementById('description').value = '';
        // Keep date and currency as they were
    }

    showSuccess() {
        const message = document.getElementById('successMessage');
        message.classList.remove('hidden');
        setTimeout(() => {
            message.classList.add('hidden');
        }, 2000);
    }

    updateDisplay() {
        this.updateStats();
        this.updateExpensesList();
    }

    updateStats() {
        const totalExpenses = this.expenses.length;
        const totalAmount = this.expenses.reduce((sum, expense) => {
            let usdAmount = expense.amount;
            if (expense.currency !== 'USD') {
                const rates = {
                    'EUR': 1.1, 'GBP': 1.25, 'JPY': 0.007, 'AUD': 0.67,
                    'CAD': 0.74, 'CHF': 1.1, 'CNY': 0.14, 'INR': 0.012,
                    'KRW': 0.00075, 'SGD': 0.74, 'THB': 0.028, 'MXN': 0.058,
                    'BRL': 0.20, 'ZAR': 0.055
                };
                usdAmount = expense.amount * (rates[expense.currency] || 1);
            }
            return sum + usdAmount;
        }, 0);

        document.getElementById('totalExpenses').textContent = totalExpenses;
        document.getElementById('totalAmount').textContent = `$${totalAmount.toFixed(2)}`;
    }

    updateExpensesList() {
        const list = document.getElementById('expensesList');

        if (this.expenses.length === 0) {
            list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No expenses yet. Add your first expense above!</p>';
            return;
        }

        list.innerHTML = this.expenses.map(expense => `
            <div class="expense-item">
                <div class="expense-date">${this.formatDate(expense.date)}</div>
                <div class="expense-amount">${expense.currency} ${expense.amount.toFixed(2)}</div>
                <div class="expense-description">${expense.description}</div>
            </div>
        `).join('');
    }

    formatDate(dateString) {
        return new Date(dateString + 'T00:00:00').toLocaleDateString('en-US', {
            weekday: 'short',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    showExport() {
        const exportArea = document.getElementById('exportArea');
        const exportText = document.getElementById('exportText');

        if (this.expenses.length === 0) {
            alert('No expenses to export yet!');
            return;
        }

        const formatted = this.expenses.map(expense => 
            `${expense.date} | ${expense.currency} ${expense.amount.toFixed(2)} | ${expense.description}`
        ).join('\n');

        exportText.value = formatted;
        exportArea.classList.remove('hidden');
        exportText.focus();
        exportText.select();
    }

    async copyToClipboard() {
        const exportText = document.getElementById('exportText');
        try {
            await navigator.clipboard.writeText(exportText.value);
            const btn = document.getElementById('copyBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        } catch (err) {
            exportText.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }
    }

    clearAll() {
        if (confirm('Are you sure you want to clear all expenses? This cannot be undone.')) {
            this.expenses = [];
            this.saveExpenses();
            this.updateDisplay();
            document.getElementById('exportArea').classList.add('hidden');
        }
    }

    // NEW: CSV download function
    downloadCSV() {
        if (this.expenses.length === 0) return;

        const headers = ['Date', 'Currency', 'Amount', 'Description'];
        const rows = this.expenses.map(expense => [
            expense.date,
            expense.currency,
            expense.amount.toFixed(2),
            expense.description
        ]);

        const csvContent = [headers, ...rows].map(r => r.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'expenses.csv';
        a.click();
        URL.revokeObjectURL(url);
    }
}

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    new ExpenseTracker();
});
</script>
